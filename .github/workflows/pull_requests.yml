name: Run tests

on:
  pull_request:
    branches: [main]

jobs:
  linux_node_ui_tests:
    name: Linux Node/UI Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}

    - uses: c-hive/gha-yarn-cache@v2
    - name: Setup Golang caches
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-golang-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-golang-

    - run: ./scripts/ci/prepare_linux.sh --integration-tests
    # Needed so we can have ./build/desktop_runner.js and ./build/go_desktop_runner ready for tests
    - run: yarn build-test-runner
    - run: yarn test --detectOpenHandles --forceExit --verbose desktop/panel/http.test.js

    - name: Upload non-credential coverage
      uses: actions/upload-artifact@v3
      with:
        name: non-credential-coverage
        path: coverage/*.cov