name: Run tests

on:
  pull_request:
    branches: [master]

jobs:  
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}
    - run: curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
    - run: sudo apt-get install -y nodejs cmake
    - run: sudo npm install --global yarn
    - run: yarn
    - run: yarn format
    - run: yarn tsc
    - run: ./scripts/fail_on_diff.sh
    - run: yarn test-licenses
    - run: yarn test-coverage

  e2e-linux:
    needs: test

    runs-on: ubuntu-latest
    container: selenium/standalone-chrome-debug

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}
    - run: curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
    - run: sudo apt-get install -y nodejs cmake xvfb
    - run: sudo npm install --global yarn
    - run: yarn release-desktop e2etest
    # Set up a virtual framebuffer so Chrome will start
    # https://www.electronjs.org/docs/tutorial/testing-on-headless-ci
    - run: echo "DISPLAY=':99.0'" >> $GITHUB_ENV
    - run: Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - run: yarn e2e-test

  e2e-macos:
    needs: test

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}
    - run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    - run: brew install nodejs cmake python3
    - run: npm install --global yarn
    - run: yarn release-desktop e2etest
    - run: yarn e2e-test

  e2e-windows:
    needs: test

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@master
      with:
        ref: ${{ github.ref }}
    - run: Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
    - run: Join-Path (Resolve-Path ~).Path "scoop\shims" >> $Env:GITHUB_PATH
    - run: scoop install nodejs cmake python yarn
    - run: yarn release-desktop e2etest
    - run: yarn e2e-test
